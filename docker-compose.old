version: '2.2'
services:
  couch:
    image: couchdb:2.1.1
    ports:
      - ${COUCH_PORT}:5984
    environment:
      COUCHDB_USER: ${COUCH_ADMIN}
      COUCHDB_PASSWORD: ${COUCH_PASS}
  postgres:
    image: postgres:9.4
    ports:
      - ${PG_PORT}:5432
    environment:
      POSTGRES_PASSWORD: postgres
  test:
    build: .
    volumes:
      - ./libs:/usr/app/libs
      - ./tests:/usr/app/tests
    depends_on:
      - couch
      - postgres
    environment:
      TEST_COUCH_URL: http://${COUCH_ADMIN}:${COUCH_PASS}@couch:5984
      TEST_PG_URL: postgres://postgres:${PG_PASS}@postgres:5432


docker pull postgres:12.1-alpine
docker pull couchdb:2.3.1

docker network create travis-couch2pg-test
docker run --name postgres --net travis-couch2pg-test -e POSTGRES_PASSWORD=postgres -d postgres
docker run --name couchdb --net travis-couch2pg-test -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=admin123 -d couchdb:2.3.1
docker build -t couch2pg-test-local1 --target test-couch2pg --network travis-couch2pg-test --build-arg COUCH_ADMIN=admin --build-arg COUCH_PASS=admin123 --build-arg PG_PASS="" .